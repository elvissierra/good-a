name: CI ‚Äî Lint, Test, and Build

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'docker-compose.yml'
      - 'backend/Dockerfile.yml'
      - 'frontend/dockerfile.yml'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'docker-compose.yml'
      - 'backend/Dockerfile.yml'
      - 'frontend/dockerfile.yml'
      - '.github/workflows/ci.yml'

jobs:
  backend:
    name: Backend ‚Äî Python tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest pytest-cov

      - name: Lint (ruff + black --check)
        run: |
          python -m pip install --upgrade pip
          pip install ruff black
          echo "üîé Running ruff..."
          ruff check .
          echo "üßπ Checking Black formatting..."
          black --check .

      - name: Run tests
        run: |
          if [ -d tests ] || ls -1 *.py 2>/dev/null | grep -q .; then \
            pytest -q --maxfail=1 --disable-warnings; \
          else \
            echo "No backend tests found; skipping"; \
          fi

  frontend:
    name: Frontend ‚Äî Build (Vite)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend/goodtoday
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: frontend/goodtoday/package-lock.json

      - name: Install
        run: npm ci

      - name: Lint (ESLint if script exists)
        run: |
          if node -e "process.exit(require('./package.json').scripts && require('./package.json').scripts.lint ? 0 : 1)"; then
            echo "üîé Running npm run lint"
            npm run lint
          else
            echo "‚ÑπÔ∏è No 'lint' script in package.json; skipping ESLint."
          fi

      - name: Build
        run: npm run build

  docker-validate:
    name: Dockerfiles ‚Äî Build validation
    runs-on: ubuntu-latest
    needs: [ backend, frontend ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Backend image build (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: backend/Dockerfile.yml
          push: false

      - name: Frontend image build (prod target, no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: frontend/dockerfile.yml
          target: prod
          push: false
